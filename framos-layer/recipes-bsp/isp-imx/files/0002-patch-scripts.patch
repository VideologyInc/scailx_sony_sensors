From bd24432ceca1e2d0cc7c7bf3732947a5adc72cae Mon Sep 17 00:00:00 2001
From: Kobus Goosen <kgoosen@videologyinc.com>
Date: Tue, 11 Feb 2025 15:35:56 +0100
Subject: [PATCH 2/4] patch scripts

---
 imx/run.sh       | 159 +++++++++++++++++++++++++++++++++++++++++------
 imx/start_isp.sh |  74 ++++++++++++++++++++++
 2 files changed, 215 insertions(+), 18 deletions(-)

diff --git a/imx/run.sh b/imx/run.sh
index 29f1957..7de5ed1 100755
--- a/imx/run.sh
+++ b/imx/run.sh
@@ -2,7 +2,7 @@
 #
 # Start the isp_media_server in the configuration from user
 # (c) NXP 2020-2022
-# (c) Basler 2020
+# (c) Framos 2024
 #
 
 RUN_SCRIPT=`realpath -s $0`
@@ -15,24 +15,11 @@ LOCAL_RUN="0" # search modules in /lib/modules and libraries in /usr/lib
 RUN_OPTION=""
 LOCAL_RUN="0"
 # an array with the modules to load, insertion order
-declare -a MODULES=("vvcam-dwe" "vvcam-isp" "vvcam-video")
+declare -a MODULES=("imx8-media-dev" "vvcam-dwe" "vvcam-isp" "vvcam-video")
 
 USAGE="Usage:\n"
 USAGE+="run.sh -c <isp_config> &\n"
 USAGE+="Supported configurations:\n"
-USAGE+="\tbasler_1080p60         - single basler camera on MIPI-CSI1, 1920x1080, 60 fps\n"
-USAGE+="\tdual_basler_1080p60    - dual basler cameras on MIPI-CSI1/2, 1920x1080, 60 fps\n"
-USAGE+="\tbasler_4k              - single basler camera on MIPI-CSI1, 3840x2160, 30 fps\n"
-USAGE+="\tbasler_1080p60hdr      - single basler camera on MIPI-CSI1, 1920x1080, 60 fps, HDR configuration\n"
-USAGE+="\tdual_basler_1080p60hdr - dual basler cameras on MIPI-CSI1/2, 1920x1080, 60 fps, HDR configuration\n"
-USAGE+="\tbasler_4khdr           - single basler camera on MIPI-CSI1, 3840x2160, 30 fps, HDR configuration\n"
-
-USAGE+="\tos08a20_1080p60         - single os08a20 camera on MIPI-CSI1, 1920x1080, 60 fps\n"
-USAGE+="\tdual_os08a20_1080p60    - dual os08a20 cameras on MIPI-CSI1/2, 1920x1080, 60 fps\n"
-USAGE+="\tos08a20_4k              - single os08a20 camera on MIPI-CSI1, 3840x2160, 30 fps\n"
-USAGE+="\tos08a20_1080p30hdr      - single os08a20 camera on MIPI-CSI1, 1920x1080, 30 fps, HDR configuration\n"
-USAGE+="\tdual_os08a20_1080p30hdr - dual os08a20 cameras on MIPI-CSI1/2, 1920x1080, 30 fps, HDR configuration\n"
-USAGE+="\tos08a20_4khdr           - single os08a20 camera on MIPI-CSI1, 3840x2160, 15 fps, HDR configuration\n"
 
 # parse command line arguments
 while [ "$1" != "" ]; do
@@ -43,9 +30,6 @@ while [ "$1" != "" ]; do
 			;;
 		-l | --local )
 			LOCAL_RUN="1"
-			# search modules and libraries near this script
-			# this should work with the flat structure from VSI/Basler
-			# but also with the output from make_isp_build_*.sh
 			;;
 		-lm | --load-modules )
 			LOAD_MODULES="1"
@@ -87,6 +71,60 @@ write_default_mode_files () {
 	echo "[mode.3]" >> DAA3840_MODES.txt
 	echo "xml = \"DAA3840_30MC_1080P-hdr.xml\"" >> DAA3840_MODES.txt
 	echo "dwe = \"dewarp_config/daA3840_30mc_1080P.json\"" >> DAA3840_MODES.txt
+
+	# IMX662 modes file
+	echo -n "" > IMX662_MODES.txt
+	echo "[mode.0]" >> IMX662_MODES.txt
+	echo "xml = \"IMX662_Basic_1920x1080.xml\"" >> IMX662_MODES.txt
+	echo "dwe = \"dewarp_config/sensor_dwe_IMX662_Basic_1920x1080.json\"" >> IMX662_MODES.txt
+	echo "[mode.1]" >> IMX662_MODES.txt
+	echo "xml = \"IMX662_Basic_1280x720.xml\"" >> IMX662_MODES.txt
+	echo "dwe = \"dewarp_config/sensor_dwe_IMX662_Basic_1280x720.json\"" >> IMX662_MODES.txt
+	echo "[mode.2]" >> IMX662_MODES.txt
+	echo "xml = \"IMX662_Basic_960x540.xml\"" >> IMX662_MODES.txt
+	echo "dwe = \"dewarp_config/sensor_dwe_IMX662_Basic_960x540.json\"" >> IMX662_MODES.txt
+	echo "[mode.3]" >> IMX662_MODES.txt
+	echo "xml = \"IMX662_Basic_640x480.xml\"" >> IMX662_MODES.txt
+	echo "dwe = \"dewarp_config/sensor_dwe_IMX662_Basic_640x480.json\"" >> IMX662_MODES.txt
+	# IMX676 modes file
+	echo -n "" > IMX676_MODES.txt
+	echo "[mode.0]" >> IMX676_MODES.txt
+	echo "xml = \"IMX676_Basic_3536x3072.xml\"" >> IMX676_MODES.txt
+	echo "dwe = \"dewarp_config/sensor_dwe_IMX676_Basic_3536x3072.json\"" >> IMX676_MODES.txt
+	echo "[mode.1]" >> IMX676_MODES.txt
+	echo "xml = \"IMX676_Basic_3536x2140.xml\"" >> IMX676_MODES.txt
+	echo "dwe = \"dewarp_config/sensor_dwe_IMX676_Basic_3536x2140.json\"" >> IMX676_MODES.txt
+	echo "[mode.2]" >> IMX676_MODES.txt
+	echo "xml = \"IMX676_Basic_1776x1778.xml\"" >> IMX676_MODES.txt
+	echo "dwe = \"dewarp_config/sensor_dwe_IMX676_Basic_1776x1778.json\"" >> IMX676_MODES.txt
+	echo "[mode.3]" >> IMX676_MODES.txt
+	echo "xml = \"IMX676_Basic_1760x1070.xml\"" >> IMX676_MODES.txt
+	echo "dwe = \"dewarp_config/sensor_dwe_IMX676_Basic_1760x1070.json\"" >> IMX676_MODES.txt
+	# IMX678 modes file
+	echo -n "" > IMX678_MODES.txt
+	echo "[mode.0]" >> IMX678_MODES.txt
+	echo "xml = \"IMX678_Basic_3840x2160.xml\"" >> IMX678_MODES.txt
+	echo "dwe = \"dewarp_config/sensor_dwe_IMX678_Basic_3840x2160.json\"" >> IMX678_MODES.txt
+	echo "[mode.1]" >> IMX678_MODES.txt
+	echo "xml = \"IMX678_Basic_1920x1080.xml\"" >> IMX678_MODES.txt
+	echo "dwe = \"dewarp_config/sensor_dwe_IMX678_Basic_1920x1080.json\"" >> IMX678_MODES.txt
+	# IMX900 modes file
+	echo -n "" > IMX900_MODES.txt
+	echo "[mode.0]" >> IMX900_MODES.txt
+	echo "xml = \"IMX900_Basic_2048x1536.xml\"" >> IMX900_MODES.txt
+	echo "dwe = \"dewarp_config/sensor_dwe_IMX900_Basic_2048x1536.json\"" >> IMX900_MODES.txt
+	echo "[mode.1]" >> IMX900_MODES.txt
+	echo "xml = \"IMX900_Basic_1920x1080.xml\"" >> IMX900_MODES.txt
+	echo "dwe = \"dewarp_config/sensor_dwe_IMX900_Basic_1920x1080.json\"" >> IMX900_MODES.txt
+	echo "[mode.2]" >> IMX900_MODES.txt
+	echo "xml = \"IMX900_Basic_1024x768.xml\"" >> IMX900_MODES.txt
+	echo "dwe = \"dewarp_config/sensor_dwe_IMX900_Basic_1024x768.json\"" >> IMX900_MODES.txt
+	echo "[mode.3]" >> IMX900_MODES.txt
+	echo "xml = \"IMX900_Basic_2048x154.xml\"" >> IMX900_MODES.txt
+	echo "dwe = \"dewarp_config/sensor_dwe_IMX900_Basic_2048x154.json\"" >> IMX900_MODES.txt
+	echo "[mode.4]" >> IMX900_MODES.txt
+	echo "xml = \"IMX900_Basic_1008x704.xml\"" >> IMX900_MODES.txt
+	echo "dwe = \"dewarp_config/sensor_dwe_IMX900_Basic_1008x704.json\"" >> IMX900_MODES.txt
 }
 
 # write the sensonr config file
@@ -308,6 +346,91 @@ case "$ISP_CONFIG" in
                          write_sensor_cfg_file "Sensor0_Entry.cfg" $CAM_NAME $DRV_FILE $MODE_FILE $MODE
                          write_sensor_cfg_file "Sensor1_Entry.cfg" $CAM_NAME $DRV_FILE $MODE_FILE $MODE
                          ;;
+		imx662 )
+			MODULES_TO_REMOVE=("max96792" "max96793" "imx662" "${MODULES[@]}")
+			MODULES=("max96792" "max96793" "imx662" "${MODULES[@]}")
+			RUN_OPTION="CAMERA0"
+			CAM_NAME="imx662"
+			DRV_FILE="imx662.drv"
+			MODE_FILE="IMX662_MODES.txt"
+			MODE="0"
+			write_sensor_cfg_file "Sensor0_Entry.cfg" $CAM_NAME $DRV_FILE $MODE_FILE $MODE
+			;;
+		dual_imx662 )
+			MODULES_TO_REMOVE=("max96792" "max96793" "imx662" "${MODULES[@]}")
+			MODULES=("max96792" "max96793" "imx662" "${MODULES[@]}")
+			RUN_OPTION="DUAL_CAMERA"
+			CAM_NAME="imx662"
+			DRV_FILE="imx662.drv"
+			MODE_FILE="IMX662_MODES.txt"
+			MODE="0"
+			write_sensor_cfg_file "Sensor0_Entry.cfg" $CAM_NAME $DRV_FILE $MODE_FILE $MODE
+			write_sensor_cfg_file "Sensor1_Entry.cfg" $CAM_NAME $DRV_FILE $MODE_FILE $MODE
+			;;
+		imx676_4k )
+			MODULES_TO_REMOVE=("max96792" "max96793" "imx676" "${MODULES[@]}")
+			MODULES=("max96792" "max96793" "imx676" "${MODULES[@]}")
+			RUN_OPTION="CAMERA0"
+			CAM_NAME="imx676"
+			DRV_FILE="imx676.drv"
+			MODE_FILE="IMX676_MODES.txt"
+			MODE="0"
+			write_sensor_cfg_file "Sensor0_Entry.cfg" $CAM_NAME $DRV_FILE $MODE_FILE $MODE
+			;;
+
+		dual_imx676_4k )
+			MODULES_TO_REMOVE=("max96792" "max96793" "imx676" "${MODULES[@]}")
+			MODULES=("max96792" "max96793" "imx676" "${MODULES[@]}")
+			RUN_OPTION="DUAL_CAMERA"
+			CAM_NAME="imx676"
+			DRV_FILE="imx676.drv"
+			MODE_FILE="IMX676_MODES.txt"
+			MODE="3"
+			write_sensor_cfg_file "Sensor0_Entry.cfg" $CAM_NAME $DRV_FILE $MODE_FILE $MODE
+			write_sensor_cfg_file "Sensor1_Entry.cfg" $CAM_NAME $DRV_FILE $MODE_FILE $MODE
+			;;
+		imx678_4k )
+			MODULES_TO_REMOVE=("max96792" "max96793" "imx678" "${MODULES[@]}")
+			MODULES=("max96792" "max96793" "imx678" "${MODULES[@]}")
+			RUN_OPTION="CAMERA0"
+			CAM_NAME="imx678"
+			DRV_FILE="imx678.drv"
+			MODE_FILE="IMX678_MODES.txt"
+			MODE="0"
+			write_sensor_cfg_file "Sensor0_Entry.cfg" $CAM_NAME $DRV_FILE $MODE_FILE $MODE
+			;;
+		dual_imx678_4k )
+			MODULES_TO_REMOVE=("max96792" "max96793" "imx678" "${MODULES[@]}")
+			MODULES=("max96792" "max96793" "imx678" "${MODULES[@]}")
+			RUN_OPTION="DUAL_CAMERA"
+			CAM_NAME="imx678"
+			DRV_FILE="imx678.drv"
+			MODE_FILE="IMX678_MODES.txt"
+			MODE="1"
+			write_sensor_cfg_file "Sensor0_Entry.cfg" $CAM_NAME $DRV_FILE $MODE_FILE $MODE
+			write_sensor_cfg_file "Sensor1_Entry.cfg" $CAM_NAME $DRV_FILE $MODE_FILE $MODE
+			;;
+		imx900_2k )
+			MODULES_TO_REMOVE=("max96792" "max96793" "imx900" "${MODULES[@]}")
+			MODULES=("max96792" "max96793" "imx900" "${MODULES[@]}")
+			RUN_OPTION="CAMERA0"
+			CAM_NAME="imx900"
+			DRV_FILE="imx900.drv"
+			MODE_FILE="IMX900_MODES.txt"
+			MODE="0"
+			write_sensor_cfg_file "Sensor0_Entry.cfg" $CAM_NAME $DRV_FILE $MODE_FILE $MODE
+			;;
+		dual_imx900_2k )
+			MODULES_TO_REMOVE=("max96792" "max96793" "imx900" "${MODULES[@]}")
+			MODULES=("max96792" "max96793" "imx900" "${MODULES[@]}")
+			RUN_OPTION="DUAL_CAMERA"
+			CAM_NAME="imx900"
+			DRV_FILE="imx900.drv"
+			MODE_FILE="IMX900_MODES.txt"
+			MODE="1"
+			write_sensor_cfg_file "Sensor0_Entry.cfg" $CAM_NAME $DRV_FILE $MODE_FILE $MODE
+			write_sensor_cfg_file "Sensor1_Entry.cfg" $CAM_NAME $DRV_FILE $MODE_FILE $MODE
+			;;
 		 *)
 			echo "ISP configuration \"$ISP_CONFIG\" unsupported."
 			echo -e "$USAGE" >&2
diff --git a/imx/start_isp.sh b/imx/start_isp.sh
index bfc7cc1..da48bca 100755
--- a/imx/start_isp.sh
+++ b/imx/start_isp.sh
@@ -12,6 +12,12 @@ NR_DEVICE_TREE_OV5640=$(grep ov5640 `find /sys/firmware/devicetree/base/soc@0/ -
 NR_DEVICE_TREE_OS08A20=$(grep os08a20 `find /sys/firmware/devicetree/base/soc@0/ -name compatible | grep i2c` -l | wc -l 2> /dev/null)
 NR_SCAILX_CAMS=$(find /proc/device-tree/chosen/overlays/cam* | wc -l 2> /dev/null)
 
+NR_DEVICE_TREE_IMX662=$(grep imx662 /sys/firmware/devicetree/base/soc@0/*/i2c@*/*/*/*/compatible -l | wc -l 2> /dev/null)
+NR_DEVICE_TREE_IMX676=$(grep imx676 /sys/firmware/devicetree/base/soc@0/*/i2c@*/*/*/*/compatible -l | wc -l 2> /dev/null)
+NR_DEVICE_TREE_IMX678=$(grep imx678 /sys/firmware/devicetree/base/soc@0/*/i2c@*/*/*/*/compatible -l | wc -l 2> /dev/null)
+NR_DEVICE_TREE_IMX900=$(grep imx900 /sys/firmware/devicetree/base/soc@0/*/i2c@*/*/*/*/compatible -l | wc -l 2> /dev/null)
+
+
 # check if the basler device has been enabled in the device tree
 if [ $NR_DEVICE_TREE_BASLER -eq 1 ]; then
 
@@ -60,6 +66,74 @@ elif [ $NR_DEVICE_TREE_OS08A20 -eq 1 ]; then
 		exec ./run.sh -c os08a20_1080p60 -lm
 	fi
 
+# check for imx662 devices
+elif [ $NR_DEVICE_TREE_IMX662 -eq 2 ]; then
+
+	echo "Starting isp_media_server for Dual IMX662"
+
+	cd $RUNTIME_DIR
+
+	exec ./run.sh -c dual_imx662 -lm
+
+elif [ $NR_DEVICE_TREE_IMX662 -eq 1 ]; then
+
+	echo "Starting isp_media_server for IMX662"
+
+	cd $RUNTIME_DIR
+
+	exec ./run.sh -c imx662 -lm
+
+# check for imx676 devices
+elif [ $NR_DEVICE_TREE_IMX676 -eq 2 ]; then
+
+	echo "Starting isp_media_server for Dual IMX676"
+
+	cd $RUNTIME_DIR
+
+	exec ./run.sh -c dual_imx676_4k -lm
+
+elif [ $NR_DEVICE_TREE_IMX676 -eq 1 ]; then
+
+	echo "Starting isp_media_server for IMX676"
+
+	cd $RUNTIME_DIR
+
+	exec ./run.sh -c imx676_4k -lm
+
+# check for imx678 devices
+elif [ $NR_DEVICE_TREE_IMX678 -eq 2 ]; then
+
+	echo "Starting isp_media_server for Dual IMX678"
+
+	cd $RUNTIME_DIR
+
+	exec ./run.sh -c dual_imx678_4k -lm
+
+elif [ $NR_DEVICE_TREE_IMX678 -eq 1 ]; then
+
+	echo "Starting isp_media_server for IMX678"
+
+	cd $RUNTIME_DIR
+
+	exec ./run.sh -c imx678_4k -lm
+
+# check for imx900 devices
+elif [ $NR_DEVICE_TREE_IMX900 -eq 2 ]; then
+
+	echo "Starting isp_media_server for Dual IMX900"
+
+	cd $RUNTIME_DIR
+
+	exec ./run.sh -c dual_imx900_2k -lm
+
+elif [ $NR_DEVICE_TREE_IMX900 -eq 1 ]; then
+
+	echo "Starting isp_media_server for IMX900"
+
+	cd $RUNTIME_DIR
+
+	exec ./run.sh -c imx900_2k -lm
+
 elif [ $NR_DEVICE_TREE_OS08A20 -eq 2 ]; then
 
 	echo "Starting isp_media_server for Dual os08a20"
-- 
2.34.1

